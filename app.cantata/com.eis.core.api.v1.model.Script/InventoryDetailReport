{
  "refName" : "InventoryDetailReport",
  "refKey" : null,
  "displayName" : "InventoryDetailReport",
  "schemaVersion" : null,
  "version" : null,
  "current" : true,
  "txId" : null,
  "keywords" : [ ],
  "tags" : [ ],
  "hashSum" : null,
  "auditInfo" : null,
  "uiactions" : [ ],
  "forced" : false,
  "objRef" : false,
  "doNotAudit" : false,
  "logicallyDeleted" : false,
  "create" : false,
  "violationsSet" : null,
  "dynAttributes" : { },
  "internal" : false,
  "referenceData" : [ ],
  "id" : "e34840c7-909a-405f-8066-ec81b9d6fa9b",
  "script" : "var channels = channelService.getList(0,-1,null,null); \r\nvar sites = siteService.getList(0,-1,null,null); \r\nvar output = new java.util.ArrayList(); \r\nvar poStatuses = [\"NEW\",\"ACKNOWLEDGED\",\"OPEN\",\"RELEASED\",\"SHIPPED\",\"PARTIALLY_SHIPPED\",\"RECEIVED\",\"PARTIALLY_RECEIVED\",\"CANCEL_PENDING\",\"RECEIVE_FAILED\"];\r\nvar poStatusQueryString = \"header.status:^[\" + poStatuses.join(',') + \"]\";\r\nvar poLineStatuses = [\"NEW\",\"ACKNOWLEDGED\",\"OPEN\",\"RELEASED\",\"SHIPPED\",\"PARTIALLY_SHIPPED\",\"RECEIVED\",\"PARTIALLY_RECEIVED\",\"CANCEL_PENDING\"];\r\nvar poLineStatusQueryString = \"lineItems.status:^[\" + poLineStatuses.join(',') + \"]\";\r\n\r\nfor(var i = 0; i < channels.size(); i++) {\r\n    var channel = channels.get(i);    \r\n    for (var s = 0; s < sites.size(); s++) {\r\n        var site = sites.get(s);\r\n        var poolIds = [];\r\n        var poolResults = inventoryPoolService.getList(0, -1, \"channels.refName:\"+channel.getRefName()+\"&&siteId:\"+site.getId(), null, null); \r\n        for(var j = 0; j < poolResults.size(); j++) {\r\n            var pool = poolResults.get(j);\r\n            poolIds.push(pool.getId());\r\n        }\r\n\r\n        if (poolIds.length > 0) {\r\n            var invFieldsToGroupBy = new java.util.ArrayList();\r\n            invFieldsToGroupBy.add(\"productIdentifier\");\r\n            var invFieldsToAgg = new java.util.ArrayList();\r\n            invFieldsToAgg.add(new com.eis.core.api.v1.model.FieldAggregationParameter(\"availableQty\", com.eis.core.api.v1.model.FieldAggregationParameter.OperationEnum.SUM));\r\n            invFieldsToAgg.add(new com.eis.core.api.v1.model.FieldAggregationParameter(\"reservedQty\", com.eis.core.api.v1.model.FieldAggregationParameter.OperationEnum.SUM));\r\n            invFieldsToAgg.add(new com.eis.core.api.v1.model.FieldAggregationParameter(\"unavailableQty\", com.eis.core.api.v1.model.FieldAggregationParameter.OperationEnum.SUM));\r\n            invFieldsToAgg.add(new com.eis.core.api.v1.model.FieldAggregationParameter(\"onOrderQty\", com.eis.core.api.v1.model.FieldAggregationParameter.OperationEnum.SUM));\r\n            var invSorts = new java.util.ArrayList();\r\n            invSorts.add(new com.eis.core.api.v1.model.SortParameter(\"productIdentifier\", com.eis.core.api.v1.model.SortParameter.SortOrderEnum.ASC));\r\n            var invQueryString = \"parentInventoryPoolId:^[\" + poolIds.join(',') + \"]\";\r\n            //aggregate to get counts\r\n            var invCounts = inventoryPoolEntryService.getAggregatedResults(invQueryString, invFieldsToGroupBy, invFieldsToAgg, invSorts);\r\n\r\n            //aggregate to get open POs\r\n            var poFieldsToAgg = new java.util.ArrayList();\r\n            poFieldsToAgg.add(new com.eis.core.api.v1.model.FieldAggregationParameter(\"lineItems.itemQty\", com.eis.core.api.v1.model.FieldAggregationParameter.OperationEnum.MAX)); //workaround to force unwrap\r\n            var poFieldsToGroupBy = new java.util.ArrayList();\r\n            poFieldsToGroupBy.add(\"header.purchaseOrderNumber\");\r\n            poFieldsToGroupBy.add(\"header.exFactoryDate\");\r\n            poFieldsToGroupBy.add(\"header.status\");\r\n            poFieldsToGroupBy.add(\"lineItems.status\");\r\n            poFieldsToGroupBy.add(\"lineItems.systemItemId\");\r\n            poFieldsToGroupBy.add(\"lineItems.itemQty\"); //can't aggregate b/c its a string in the db right\r\n            var poSorts = new java.util.ArrayList();\r\n            poSorts.add(new com.eis.core.api.v1.model.SortParameter(\"lineItems.systemItemId\", com.eis.core.api.v1.model.SortParameter.SortOrderEnum.ASC));\r\n            poSorts.add(new com.eis.core.api.v1.model.SortParameter(\"header.exFactoryDate\", com.eis.core.api.v1.model.SortParameter.SortOrderEnum.DESC));\r\n\r\n\r\n            //probably need to switch to equals for the lineItem statuses\r\n            poQueryString = \"lineItems.destinationInventoryPoolId:^[\" + poolIds.join(',') \r\n            + \"]&&\"+poStatusQueryString + \"&&\" + poLineStatusQueryString;\r\n\r\n            //aggregate to get counts\r\n            var poCounts = purchaseOrderService.getAggregatedResults(poQueryString, poFieldsToGroupBy, poFieldsToAgg, poSorts);\r\n            var channelSiteMap = new java.util.LinkedHashMap(); \r\n            channelSiteMap.put(\"channel\", channel.getRefName());\r\n            channelSiteMap.put(\"site\", site.getRefName());\r\n            channelSiteMap.put(\"count\", invCounts);\r\n            channelSiteMap.put(\"pos\", poCounts);\r\n            \r\n            output.add(channelSiteMap);\r\n        }\r\n    }\r\n}",
  "compensateScript" : null,
  "language" : null,
  "type" : {
    "refName" : "InventoryReportType",
    "refKey" : "1f618d6e4db7437eba6fce7ae1d9ca33",
    "displayName" : null,
    "schemaVersion" : null,
    "version" : null,
    "current" : true,
    "txId" : null,
    "keywords" : [ ],
    "tags" : [ ],
    "hashSum" : null,
    "auditInfo" : null,
    "uiactions" : [ ],
    "forced" : false,
    "objRef" : false,
    "doNotAudit" : false,
    "logicallyDeleted" : false,
    "create" : false,
    "violationsSet" : null,
    "dynAttributes" : { },
    "internal" : false,
    "referenceData" : [ ],
    "id" : "6bb10e8e-6f6c-4161-ac0a-99773340261b",
    "inputs" : {
      "name" : null,
      "attributes" : { }
    },
    "outputs" : {
      "name" : null,
      "attributes" : {
        "output" : {
          "id" : null,
          "refName" : "output",
          "type" : "Object",
          "value" : null,
          "className" : null,
          "selectValues" : [ ],
          "selectValuesType" : null,
          "selectValuesKey" : null,
          "defaultValue" : null,
          "required" : true,
          "inheritable" : false,
          "hidden" : false,
          "displayOnFrontend" : true,
          "label" : "Output Map",
          "description" : null
        }
      }
    },
    "scriptContextObjects" : {
      "channelService" : {
        "type" : "serviceBean",
        "name" : "channelService",
        "methodName" : null,
        "modelName" : null,
        "serviceName" : "channelService",
        "parameterName" : null,
        "parameters" : { }
      },
      "inventoryPoolEntryService" : {
        "type" : "serviceBean",
        "name" : "inventoryPoolEntryService",
        "methodName" : null,
        "modelName" : null,
        "serviceName" : "inventoryPoolEntryService",
        "parameterName" : null,
        "parameters" : { }
      },
      "inventoryPoolService" : {
        "type" : "serviceBean",
        "name" : "inventoryPoolService",
        "methodName" : null,
        "modelName" : null,
        "serviceName" : "inventoryPoolService",
        "parameterName" : null,
        "parameters" : { }
      },
      "purchaseOrderService" : {
        "type" : "serviceBean",
        "name" : "purchaseOrderService",
        "methodName" : null,
        "modelName" : null,
        "serviceName" : "purchaseOrderService",
        "parameterName" : null,
        "parameters" : { }
      },
      "siteService" : {
        "type" : "serviceBean",
        "name" : "siteService",
        "methodName" : null,
        "modelName" : null,
        "serviceName" : "siteService",
        "parameterName" : null,
        "parameters" : { }
      }
    },
    "type" : "GENERIC",
    "eventType" : null,
    "scheduledActionTriggerRef" : null,
    "dataDomains" : [ "app.cantata" ]
  },
  "functionType" : "reportData",
  "inputs" : { },
  "result" : null,
  "active" : true,
  "blacklisted" : false,
  "blacklistReason" : null,
  "scriptTracer" : null,
  "scriptSecurityPolicy" : {
    "refName" : "ReportPolicy",
    "refKey" : "741bdd034bca819dd4277ef98f1941cc",
    "displayName" : null,
    "schemaVersion" : null,
    "version" : null,
    "current" : true,
    "txId" : null,
    "keywords" : [ ],
    "tags" : [ ],
    "hashSum" : null,
    "auditInfo" : null,
    "uiactions" : [ ],
    "forced" : false,
    "objRef" : false,
    "doNotAudit" : false,
    "logicallyDeleted" : false,
    "create" : false,
    "violationsSet" : null,
    "dynAttributes" : { },
    "internal" : false,
    "referenceData" : [ ],
    "id" : "33882519-a999-4d4e-a5cc-d744ecd56cb2",
    "allowedPackages" : {
      "comeisb2bmbapiv1common" : "com.eis.b2bmb.api.v1.common",
      "comeiscoreapiv1model" : "com.eis.core.api.v1.model",
      "comeiscoreapiv1service" : "com.eis.core.api.v1.service",
      "comeisssitapiv1model" : "com.eis.ssit.api.v1.model",
      "comeisssitapiv1services" : "com.eis.ssit.api.v1.services",
      "comeisssitapiv1servicesimpl" : "com.eis.ssit.api.v1.services.impl",
      "comopencsv" : "com.opencsv",
      "javalang" : "java.lang",
      "javautil" : "java.util",
      "orgjodatime" : "org.joda.time"
    },
    "allowedClasses" : { },
    "allowedMethods" : { },
    "permissionsNeeded" : { },
    "dataDomains" : [ "app.cantata" ]
  },
  "scriptTypeObjRef" : {
    "refName" : "InventoryReportType",
    "refId" : null,
    "refKey" : "1f618d6e4db7437eba6fce7ae1d9ca33",
    "displayName" : null,
    "dataDomain" : "app.cantata",
    "type" : "com.eis.core.api.v1.model.ScriptType",
    "nullable" : false,
    "internal" : false,
    "parentId" : null,
    "parentType" : null
  },
  "scriptSecurityPolicyObjRef" : {
    "refName" : "ReportPolicy",
    "refId" : null,
    "refKey" : "741bdd034bca819dd4277ef98f1941cc",
    "displayName" : null,
    "dataDomain" : "app.cantata",
    "type" : "com.eis.core.api.v1.model.ScriptSecurityPolicy",
    "nullable" : false,
    "internal" : false,
    "parentId" : null,
    "parentType" : null
  },
  "runAsId" : null,
  "runAsDefaultDataDomain" : null,
  "dataDomains" : [ "app.cantata" ]
}